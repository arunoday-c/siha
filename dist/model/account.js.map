{"version":3,"sources":["../../src/model/account.js"],"names":["getUserNamePassWord","temp","base64String","split","buffer","Buffer","UserNamePassword","toString","username","password","e","console","error","apiAuth","req","res","next","authModel","db","dataBaseNotInitilizedError","authHeader","headers","generateError","unAuthorized","inputData","badRequest","body","getConnection","connection","query","result","release","length","success","results","authUser","role_id","rec","records","secureModels","activeModels","module","exports"],"mappings":"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","file":"account.js","sourcesContent":["import extend from \"extend\";\r\nimport httpStatus from \"../utils/httpStatus\";\r\nimport { debugLog } from \"../utils/logging\";\r\n\r\nlet getUserNamePassWord = base64String => {\r\n  try {\r\n    const temp = base64String.split(\" \");\r\n    const buffer = new Buffer(temp[1], \"base64\");\r\n    const UserNamePassword = buffer.toString().split(\":\");\r\n    return {\r\n      username: UserNamePassword[0],\r\n      password: UserNamePassword[1]\r\n    };\r\n  } catch (e) {\r\n    console.error(e);\r\n  }\r\n};\r\n\r\n//api authentication\r\nlet apiAuth = (req, res, next) => {\r\n  let authModel = {\r\n    username: \"\",\r\n    password: \"\"\r\n  };\r\n  try {\r\n    let db;\r\n    if (req.db == null) {\r\n      next(httpStatus.dataBaseNotInitilizedError());\r\n    } else {\r\n      db = req.db;\r\n    }\r\n    let authHeader = req.headers[\"authorization\"];\r\n    if (!authHeader || authHeader == \"\") {\r\n      next(\r\n        httpStatus.generateError(\r\n          httpStatus.unAuthorized,\r\n          \"Missing authorization token\"\r\n        )\r\n      );\r\n    }\r\n\r\n    let inputData = extend(authModel, getUserNamePassWord(authHeader));\r\n\r\n    if (inputData.username == null || inputData.username == \"\") {\r\n      next(\r\n        httpStatus.generateError(\r\n          httpStatus.badRequest,\r\n          \"User name can not blank\"\r\n        )\r\n      );\r\n    }\r\n    if (inputData.password == null || inputData.password == \"\") {\r\n      next(\r\n        httpStatus.generateError(\r\n          httpStatus.badRequest,\r\n          \"Password can not blank\"\r\n        )\r\n      );\r\n    }\r\n    req.body = inputData;\r\n    db.getConnection((error, connection) => {\r\n      if (error) {\r\n        next(error);\r\n      }\r\n      connection.query(\r\n        \"SELECT username FROM algaeh_d_api_auth WHERE password=md5(?)\\\r\n            AND record_status='A' AND username =?\",\r\n        [inputData.password, inputData.username],\r\n        (error, result) => {\r\n          connection.release();\r\n          if (error) {\r\n            next(error);\r\n          }\r\n          if (result.length == 1) {\r\n            req.result = {\r\n              success: true,\r\n              results: result[0]\r\n            };\r\n            next();\r\n          } else {\r\n            next(\r\n              httpStatus.generateError(\r\n                httpStatus.unAuthorized,\r\n                \"Authentication service error please contact to your service provider\"\r\n              )\r\n            );\r\n          }\r\n        }\r\n      );\r\n    });\r\n  } catch (e) {\r\n    next(e);\r\n  }\r\n};\r\n\r\n//api user authentication\r\nlet authUser = (req, res, next) => {\r\n  let authModel = {\r\n    username: \"\",\r\n    password: \"\"\r\n  };\r\n  try {\r\n    if (req.db == null) {\r\n      next(httpStatus.dataBaseNotInitilizedError());\r\n    }\r\n    let db = req.db;\r\n    let inputData = extend(authModel, req.body);\r\n\r\n    db.getConnection((error, connection) => {\r\n      let query =\r\n        \"select algaeh_d_app_user.algaeh_d_app_user_id,algaeh_d_app_user.username, \\\r\n      user_displayname,user_type,locked,login_attempts,password_expiry_rule, \\\r\n      change_password,password_expiry_date,hims_m_employee_department_mappings.employee_id,\\\r\n      hims_m_employee_department_mappings.sub_department_id ,app_group_id,algaeh_m_group_user_mappings.role_id \\\r\n      from algaeh_d_app_user,algaeh_d_app_password,hims_m_employee_department_mappings,algaeh_m_group_user_mappings \\\r\n      WHERE algaeh_d_app_user.record_status='A' AND algaeh_d_app_password.record_status='A' \\\r\n      AND algaeh_d_app_password.password=md5(?) AND algaeh_d_app_user.username=? \\\r\n      AND hims_m_employee_department_mappings.user_id=algaeh_d_app_user.algaeh_d_app_user_id \\\r\n      AND algaeh_m_group_user_mappings.user_id=algaeh_d_app_user.algaeh_d_app_user_id\";\r\n\r\n      connection.query(\r\n        query,\r\n        [inputData.password, inputData.username],\r\n        (error, result) => {\r\n          if (error) {\r\n            connection.release();\r\n            next(error);\r\n          }\r\n          if (result != null && result.length != 0) {\r\n            connection.query(\r\n              \"select module_name,module_desc from algaeh_d_app_privilege,algaeh_d_app_screens where role_id =? and  \\\r\n            algaeh_d_app_privilege.screen_id = algaeh_d_app_screens.algaeh_app_screens_id\",\r\n              [result[0].role_id],\r\n              (error, rec) => {\r\n                connection.release();\r\n                if (error) {\r\n                  connection.release();\r\n                  next(error);\r\n                }\r\n                req.records = result;\r\n                req.secureModels = rec;\r\n                next();\r\n              }\r\n            );\r\n          } else {\r\n            req.records = result;\r\n            req.activeModels = [];\r\n            next();\r\n          }\r\n        }\r\n      );\r\n    });\r\n  } catch (e) {\r\n    next(e);\r\n  }\r\n};\r\n\r\nmodule.exports = {\r\n  apiAuth,\r\n  authUser\r\n};\r\n"]}