{"version":3,"sources":["../../src/model/account.js"],"names":["getUserNamePassWord","temp","base64String","split","buffer","Buffer","UserNamePassword","toString","username","password","e","console","error","apiAuth","req","res","next","authModel","db","dataBaseNotInitilizedError","authHeader","headers","generateError","unAuthorized","inputData","badRequest","body","getConnection","connection","query","result","release","length","success","results","authUser","role_id","rec","records","secureModels","activeModels","module","exports"],"mappings":"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","file":"account.js","sourcesContent":["import extend from \"extend\";\nimport httpStatus from \"../utils/httpStatus\";\nimport { debugLog } from \"../utils/logging\";\n\nlet getUserNamePassWord = base64String => {\n  try {\n    const temp = base64String.split(\" \");\n    const buffer = new Buffer(temp[1], \"base64\");\n    const UserNamePassword = buffer.toString().split(\":\");\n    return {\n      username: UserNamePassword[0],\n      password: UserNamePassword[1]\n    };\n  } catch (e) {\n    console.error(e);\n  }\n};\n\n//api authentication\nlet apiAuth = (req, res, next) => {\n  let authModel = {\n    username: \"\",\n    password: \"\"\n  };\n  try {\n    let db;\n    if (req.db == null) {\n      next(httpStatus.dataBaseNotInitilizedError());\n    } else {\n      db = req.db;\n    }\n    let authHeader = req.headers[\"authorization\"];\n    if (!authHeader || authHeader == \"\") {\n      next(\n        httpStatus.generateError(\n          httpStatus.unAuthorized,\n          \"Missing authorization token\"\n        )\n      );\n    }\n\n    let inputData = extend(authModel, getUserNamePassWord(authHeader));\n\n    if (inputData.username == null || inputData.username == \"\") {\n      next(\n        httpStatus.generateError(\n          httpStatus.badRequest,\n          \"User name can not blank\"\n        )\n      );\n    }\n    if (inputData.password == null || inputData.password == \"\") {\n      next(\n        httpStatus.generateError(\n          httpStatus.badRequest,\n          \"Password can not blank\"\n        )\n      );\n    }\n    req.body = inputData;\n    db.getConnection((error, connection) => {\n      if (error) {\n        next(error);\n      }\n      connection.query(\n        \"SELECT username FROM algaeh_d_api_auth WHERE password=md5(?)\\\n            AND record_status='A' AND username =?\",\n        [inputData.password, inputData.username],\n        (error, result) => {\n          connection.release();\n          if (error) {\n            next(error);\n          }\n          if (result.length == 1) {\n            req.result = {\n              success: true,\n              results: result[0]\n            };\n            next();\n          } else {\n            next(\n              httpStatus.generateError(\n                httpStatus.unAuthorized,\n                \"Authentication service error please contact to your service provider\"\n              )\n            );\n          }\n        }\n      );\n    });\n  } catch (e) {\n    next(e);\n  }\n};\n\n//api user authentication\nlet authUser = (req, res, next) => {\n  let authModel = {\n    username: \"\",\n    password: \"\"\n  };\n  try {\n    if (req.db == null) {\n      next(httpStatus.dataBaseNotInitilizedError());\n    }\n    let db = req.db;\n    let inputData = extend(authModel, req.body);\n\n    db.getConnection((error, connection) => {\n      let query =\n        \"select algaeh_d_app_user.algaeh_d_app_user_id,algaeh_d_app_user.username, \\\n      user_displayname,user_type,locked,login_attempts,password_expiry_rule, \\\n      change_password,password_expiry_date,hims_m_employee_department_mappings.employee_id,\\\n      hims_m_employee_department_mappings.sub_department_id ,app_group_id,algaeh_m_group_user_mappings.role_id \\\n      from algaeh_d_app_user,algaeh_d_app_password,hims_m_employee_department_mappings,algaeh_m_group_user_mappings \\\n      WHERE algaeh_d_app_user.record_status='A' AND algaeh_d_app_password.record_status='A' \\\n      AND algaeh_d_app_password.password=md5(?) AND algaeh_d_app_user.username=? \\\n      AND hims_m_employee_department_mappings.user_id=algaeh_d_app_user.algaeh_d_app_user_id \\\n      AND algaeh_m_group_user_mappings.user_id=algaeh_d_app_user.algaeh_d_app_user_id\";\n\n      connection.query(\n        query,\n        [inputData.password, inputData.username],\n        (error, result) => {\n          if (error) {\n            connection.release();\n            next(error);\n          }\n          if (result != null && result.length != 0) {\n            connection.query(\n              \"select module_name,module_desc from algaeh_d_app_privilege,algaeh_d_app_screens where role_id =? and  \\\n            algaeh_d_app_privilege.screen_id = algaeh_d_app_screens.algaeh_app_screens_id\",\n              [result[0].role_id],\n              (error, rec) => {\n                connection.release();\n                if (error) {\n                  connection.release();\n                  next(error);\n                }\n                req.records = result;\n                req.secureModels = rec;\n                next();\n              }\n            );\n          } else {\n            req.records = result;\n            req.activeModels = [];\n            next();\n          }\n        }\n      );\n    });\n  } catch (e) {\n    next(e);\n  }\n};\n\nmodule.exports = {\n  apiAuth,\n  authUser\n};\n"]}