{"version":3,"sources":["../../src/model/visit.js"],"names":["insertPatientVisitData","req","res","next","inputParam","hims_f_patient_visit_id","patient_id","visit_type","visit_date","Date","visit_code","age_in_years","age_in_months","age_in_days","insured","sec_insured","department_id","sub_department_id","doctor_id","maternity_patient","is_mlc","mlc_accident_reg_no","mlc_police_station","mlc_wound_certified_date","created_by","created_date","updated_by","updated_date","record_status","patient_message","is_critical_message","message_active_till","visit_expiery_date","episode_id","consultation","query","body","db","options","internalInsertPatientVisitData","fromDate","date_of_birth","toDate","years","diff","add","months","days","error","visitresult","rollback","onFailure","visit_id","insertId","patient_visit_id","resultData","eror","onSuccess","expResult","existingExparyDate","length","format","currentPatientEpisodeNo","currentEpisodeNo","undefined","today","record","generateError","notModified","parseInt","nextEpisodeNo","updateResult","dataBase","noContent","e","addVisit","dataBaseNotInitilizedError","getConnection","connection","beginTransaction","insertVisitData","result","commit","records","numUpdate","completeNumber","callBack","visitDetails","release","log","updateVisit","updateData","checkVisitExists","module","exports"],"mappings":"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","file":"visit.js","sourcesContent":["import extend from \"extend\";\nimport httpStatus from \"../utils/httpStatus\";\nimport { debugLog, debugFunction, logger } from \"../utils/logging\";\nimport { whereCondition, runningNumber, releaseDBConnection } from \"../utils\";\nimport moment from \"moment\";\n\n//Added by noor for code optimization\nlet insertPatientVisitData = (req, res, next) => {\n  try {\n    debugFunction(\"insertPatientVisitData\");\n    let inputParam = extend(\n      {\n        hims_f_patient_visit_id: null,\n        patient_id: null,\n        visit_type: null,\n        visit_date: new Date(),\n        visit_code: null,\n        age_in_years: null,\n        age_in_months: null,\n        age_in_days: null,\n        insured: null,\n        sec_insured: null,\n        department_id: null,\n        sub_department_id: null,\n        doctor_id: null,\n        maternity_patient: null,\n        is_mlc: null,\n        mlc_accident_reg_no: null,\n        mlc_police_station: null,\n        mlc_wound_certified_date: null,\n        created_by: null,\n        created_date: null,\n        updated_by: null,\n        updated_date: null,\n        record_status: null,\n        patient_message: null,\n        is_critical_message: null,\n        message_active_till: null,\n        visit_expiery_date: null,\n        episode_id: null,\n        consultation: null\n      },\n      req.query[\"data\"] == null ? req.body : req.query\n    );\n\n    let db = req.options != null ? req.options.db : req.db;\n\n    const internalInsertPatientVisitData = () => {\n      inputParam.patient_id = req.patient_id;\n      if (inputParam.age_in_years == null) {\n        let fromDate = moment(inputParam.date_of_birth);\n        let toDate = new Date();\n        let years = moment(toDate).diff(fromDate, \"year\");\n        fromDate.add(years, \"years\");\n        let months = moment(toDate).diff(fromDate, \"months\");\n        fromDate.add(months, \"months\");\n        let days = moment(toDate).diff(fromDate, \"days\");\n        inputParam.age_in_years = years;\n        inputParam.age_in_months = months;\n        inputParam.age_in_days = days;\n      }\n      debugLog(\"inside internalInsertPatientVisitData\");\n      db.query(\n        \"INSERT INTO `hims_f_patient_visit` (`patient_id`, `visit_type`, \\\n`age_in_years`, `age_in_months`, `age_in_days`, `insured`,`sec_insured`,\\\n`visit_date`, `department_id`, `sub_department_id`, `doctor_id`, `maternity_patient`,\\\n`is_mlc`, `mlc_accident_reg_no`, `mlc_police_station`, `mlc_wound_certified_date`, \\\n`created_by`, `created_date`,`visit_code`,`visit_expiery_date`,`episode_id`)\\\nVALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?);\",\n        [\n          inputParam.patient_id,\n          inputParam.visit_type,\n          inputParam.age_in_years,\n          inputParam.age_in_months,\n          inputParam.age_in_days,\n          inputParam.insured,\n          inputParam.sec_insured,\n          inputParam.visit_date,\n          inputParam.department_id,\n          inputParam.sub_department_id,\n          inputParam.doctor_id,\n          inputParam.maternity_patient,\n          inputParam.is_mlc,\n          inputParam.mlc_accident_reg_no,\n          inputParam.mlc_police_station,\n          inputParam.mlc_wound_certified_date,\n          inputParam.created_by,\n          new Date(),\n          inputParam.visit_code,\n          inputParam.visit_expiery_date,\n          inputParam.episode_id\n        ],\n        (error, visitresult) => {\n          if (error) {\n            if (req.options == null) {\n              db.rollback(() => {\n                releaseDBConnection(req.db, db);\n              });\n            } else {\n              req.options.onFailure(error);\n            }\n          }\n          req.visit_id = visitresult.insertId;\n          let patient_visit_id = visitresult.insertId;\n\n          if (patient_visit_id != null) {\n            db.query(\n              \"INSERT INTO `hims_f_patient_visit_message` (`patient_visit_id`\\\n, `patient_message`, `is_critical_message`, `message_active_till`, `created_by`, `created_date`\\\n) VALUES ( ?, ?, ?, ?, ?, ?);\",\n              [\n                patient_visit_id,\n                inputParam.patient_message,\n                inputParam.is_critical_message,\n                inputParam.message_active_till,\n                inputParam.created_by,\n                new Date()\n              ],\n              (error, resultData) => {\n                if (error) {\n                  if (req.options == null) {\n                    db.rollback(() => {\n                      releaseDBConnection(req.db, db);\n                      next(error);\n                    });\n                  } else {\n                    req.options.onFailure(eror);\n                  }\n                } else {\n                  req.options.onSuccess(visitresult);\n                }\n              }\n            );\n          }\n        }\n      );\n    };\n    //for consultaion\n    if (inputParam.consultation == \"Y\") {\n      debugLog(\"In consultation == Y \");\n      db.query(\n        \" select max(visit_expiery_date) as visit_expiery_date,episode_id from hims_f_patient_visit where\\\n         patient_id=? and doctor_id=? and record_status='A' group by patient_id, doctor_id;\",\n        [inputParam.patient_id, inputParam.doctor_id],\n        (error, expResult) => {\n          debugLog(\"In consultation Query\");\n          if (error) {\n            if (req.options == null) {\n              db.rollback(() => {\n                releaseDBConnection(req.db, db);\n              });\n            } else {\n              req.options.onFailure(error);\n            }\n          } else {\n            let existingExparyDate = null;\n            // let currentPatientEpisodeNo = null;\n            //fetching expiry date and episode id for existing patient\n            if (expResult[0] != null || expResult.length != 0) {\n              existingExparyDate = moment(\n                expResult[0][\"visit_expiery_date\"]\n              ).format(\"YYYY-MM-DD\");\n              currentPatientEpisodeNo = expResult[0][\"episode_id\"];\n            }\n            let currentEpisodeNo = null;\n            //checking expiry if expired or not_there create new expiry date\n            if (\n              existingExparyDate == null ||\n              existingExparyDate == undefined ||\n              existingExparyDate < today\n            ) {\n              //create new expiry date\n              db.query(\n                \"SELECT param_value,episode_id from algaeh_d_app_config WHERE algaeh_d_app_config_id=11 \\\n    and record_status='A'\",\n                (error, record) => {\n                  debugLog(\"In Expiry date records \", record);\n                  if (error) {\n                    if (req.options == null) {\n                      db.rollback(() => {\n                        releaseDBConnection(req.db, db);\n                        next(error);\n                      });\n                    } else {\n                      req.options.onFailure(error);\n                    }\n                  } else {\n                    if (record.length == 0) {\n                      if (req.options == null) {\n                        db.rollback(() => {\n                          releaseDBConnection(req.db, db);\n                          next(\n                            httpStatus.generateError(\n                              httpStatus.notModified,\n                              \"Episode value not found.Please contact administrator.\"\n                            )\n                          );\n                        });\n                      } else {\n                        req.options.onFailure(\n                          httpStatus.generateError(\n                            httpStatus.notModified,\n                            \"Episode value not found.Please contact administrator.\"\n                          )\n                        );\n                      }\n                    }\n                    inputParam.visit_expiery_date = moment()\n                      .add(parseInt(record[0][\"param_value\"]), \"days\")\n                      .format(\"YYYY-MM-DD\");\n                    currentEpisodeNo = record[0].episode_id;\n\n                    if (currentEpisodeNo > 0) {\n                      let nextEpisodeNo = currentEpisodeNo + 1;\n                      inputParam.episode_id = currentEpisodeNo;\n                      db.query(\n                        \"update algaeh_d_app_config set episode_id=? where algaeh_d_app_config_id=11 and record_status='A' \",\n                        [nextEpisodeNo],\n                        (error, updateResult) => {\n                          if (error) {\n                            if (req.options == null) {\n                              db.rollback(() => {\n                                releaseDBConnection(req.db, dataBase);\n                                next(error);\n                              });\n                            } else {\n                              req.options.onFailure(error);\n                            }\n                          } else {\n                            internalInsertPatientVisitData();\n                          }\n                        }\n                      );\n                    }\n                  }\n                }\n              );\n            }\n          }\n        }\n      );\n    }\n    //for non consultaion\n    else if (inputParam.consultation == \"N\") {\n      inputParam.visit_expiery_date = new Date();\n      inputParam.episode_id = null;\n      internalInsertPatientVisitData();\n    } else {\n      if (req.options == null) {\n        db.rollback(() => {\n          releaseDBConnection(req.db, db);\n          next(\n            httpStatus.generateError(\n              httpStatus.noContent,\n              \"Please select consultation type\"\n            )\n          );\n        });\n      } else {\n        req.options.onFailure(\n          httpStatus.generateError(\n            httpStatus.noContent,\n            \"Please select consultation type\"\n          )\n        );\n      }\n    }\n  } catch (e) {\n    next(e);\n  }\n};\n\n//----end\n\nlet addVisit = (req, res, next) => {\n  try {\n    debugFunction(\"addVisit\");\n    if (req.db == null) {\n      next(httpStatus.dataBaseNotInitilizedError());\n    }\n    let db = req.db;\n    db.getConnection((error, connection) => {\n      if (error) {\n        next(error);\n      }\n      connection.beginTransaction(error => {\n        if (error) {\n          connection.rollback(() => {\n            next(error);\n          });\n        }\n\n        let patient_id =\n          req.body.patient_id != null\n            ? req.body.patient_id\n            : req.query.patient_id;\n        let visit_code =\n          req.body.visit_code != null\n            ? req.body.visit_code\n            : req.query.visit_code;\n        if (visit_code != \"\" && patient_id != null) {\n          insertVisitData(connection, req, res, (error, result) => {\n            if (error) {\n              connection.rollback(() => {\n                next(error);\n              });\n            }\n            connection.commit(error => {\n              if (error) {\n                connection.rollback(() => {\n                  next(error);\n                });\n              }\n              req.records = result;\n              next();\n            });\n          });\n        } else {\n          if (patient_id == null) {\n            next(\n              httpStatus.generateError(400, \"Patient Code is not generated\")\n            );\n          } else {\n            runningNumber(\n              connection,\n              2,\n              \"VISIT_NUMGEN\",\n              (error, numUpdate, completeNumber) => {\n                if (error) {\n                  connection.rollback(() => {\n                    releaseDBConnection(db, connection);\n                    next(error);\n                  });\n                }\n                req.query.visit_code = completeNumber;\n                req.body.visit_code = completeNumber;\n                debugLog(\"req.body.visit_code : \" + completeNumber);\n                insertVisitData(connection, req, res, (error, result) => {\n                  if (error) {\n                    connection.rollback(() => {\n                      next(error);\n                    });\n                  }\n                  connection.commit(error => {\n                    if (error) {\n                      connection.rollback(() => {\n                        next(error);\n                      });\n                    }\n                    req.records = result;\n                    next();\n                  });\n                });\n              }\n            );\n          }\n        }\n      });\n    });\n  } catch (e) {\n    next(e);\n  }\n};\n\nlet insertVisitData = (dataBase, req, res, callBack) => {\n  let visitDetails = {\n    hims_f_patient_visit_id: null,\n    patient_id: null,\n    visit_type: null,\n    visit_date: new Date(),\n    visit_code: null,\n    age_in_years: null,\n    age_in_months: null,\n    age_in_days: null,\n    insured: null,\n    sec_insured: null,\n    department_id: null,\n    sub_department_id: null,\n    doctor_id: null,\n    maternity_patient: null,\n    is_mlc: null,\n    mlc_accident_reg_no: null,\n    mlc_police_station: null,\n    mlc_wound_certified_date: null,\n    created_by: null,\n    created_date: null,\n    updated_by: null,\n    updated_date: null,\n    record_status: null,\n    patient_message: null,\n    is_critical_message: null,\n    message_active_till: null,\n    visit_expiery_date: null,\n    episode_id: null,\n    consultation: null\n  };\n  try {\n    debugFunction(\"insertVisitData\");\n    let inputParam = extend(\n      visitDetails,\n      req.query[\"data\"] == null ? req.body : req.query\n    );\n\n    let today = moment().format(\"YYYY-MM-DD\");\n\n    //for consultaion\n    if (inputParam.consultation == \"Y\") {\n      dataBase.query(\n        \" select max(visit_expiery_date) as visit_expiery_date,episode_id from hims_f_patient_visit where\\\n         patient_id=? and doctor_id=? and record_status='A' group by patient_id, doctor_id;\",\n        [inputParam.patient_id, inputParam.doctor_id],\n        (error, expResult) => {\n          if (error) {\n            dataBase.rollback(() => {\n              dataBase.release();\n              debugLog(\"error \", error);\n            });\n          }\n\n          let existingExparyDate = null;\n          let currentPatientEpisodeNo = null;\n\n          //fetching expiry date and episode id for existing patient\n          if (expResult[0] != null || expResult.length != 0) {\n            existingExparyDate = moment(\n              expResult[0][\"visit_expiery_date\"]\n            ).format(\"YYYY-MM-DD\");\n\n            debugLog(\"existingExparyDate:\", existingExparyDate);\n\n            currentPatientEpisodeNo = expResult[0][\"episode_id\"];\n            debugLog(\"currentPatientEpisodeNo:\", currentPatientEpisodeNo);\n          }\n\n          let currentEpisodeNo = null;\n\n          //checking expiry if expired or not_there create new expiry date\n          if (\n            existingExparyDate == null ||\n            existingExparyDate == undefined ||\n            existingExparyDate < today\n          ) {\n            //create new expiry date\n            dataBase.query(\n              \"SELECT param_value from algaeh_d_app_config WHERE param_name=?\",\n              [\"VISITEXPERIDAY\"],\n              (error, record) => {\n                if (error) {\n                  dataBase.rollback(() => {\n                    dataBase.release();\n                    logger.log(\"error\", \"Add new visit %j\", error);\n                  });\n                }\n\n                inputParam.visit_expiery_date = moment()\n                  .add(\n                    record != null && record.length != 0\n                      ? parseInt(record[0][\"param_value\"])\n                      : 0,\n                    \"days\"\n                  )\n                  .format(\"YYYY-MM-DD\");\n                debugLog(\n                  \"new expiry date created:\",\n                  inputParam.visit_expiery_date\n                );\n\n                // create new episode\n                dataBase.query(\n                  \"select episode_id from algaeh_d_app_config where algaeh_d_app_config_id=11 and record_status='A'\",\n                  (error, result) => {\n                    if (error) {\n                      releaseDBConnection(req.db, dataBase);\n                      next(error);\n                    }\n\n                    currentEpisodeNo = result[0].episode_id;\n                    debugLog(\"currentEpisodeNo:\", currentEpisodeNo);\n\n                    //increament episode id\n                    if (currentEpisodeNo > 0) {\n                      let nextEpisodeNo = currentEpisodeNo + 1;\n                      debugLog(\"nextEpisodeNo :\", nextEpisodeNo);\n                      inputParam.episode_id = currentEpisodeNo;\n\n                      dataBase.query(\n                        \"update algaeh_d_app_config set episode_id=? where algaeh_d_app_config_id=11 and record_status='A' \",\n                        [nextEpisodeNo],\n                        (error, updateResult) => {\n                          if (error) {\n                            dataBase.rollback(() => {\n                              releaseDBConnection(req.db, dataBase);\n                              next(error);\n                            });\n                          }\n\n                          // inserting patient visit\n                          dataBase.query(\n                            \"INSERT INTO `hims_f_patient_visit` (`patient_id`, `visit_type`, \\\n    `age_in_years`, `age_in_months`, `age_in_days`, `insured`,`sec_insured`,\\\n  `visit_date`, `department_id`, `sub_department_id`, `doctor_id`, `maternity_patient`,\\\n   `is_mlc`, `mlc_accident_reg_no`, `mlc_police_station`, `mlc_wound_certified_date`, \\\n   `created_by`, `created_date`,`visit_code`,`visit_expiery_date`,`episode_id`)\\\n  VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?);\",\n                            [\n                              inputParam.patient_id,\n                              inputParam.visit_type,\n                              inputParam.age_in_years,\n                              inputParam.age_in_months,\n                              inputParam.age_in_days,\n                              inputParam.insured,\n                              inputParam.sec_insured,\n                              inputParam.visit_date,\n                              inputParam.department_id,\n                              inputParam.sub_department_id,\n                              inputParam.doctor_id,\n                              inputParam.maternity_patient,\n                              inputParam.is_mlc,\n                              inputParam.mlc_accident_reg_no,\n                              inputParam.mlc_police_station,\n                              inputParam.mlc_wound_certified_date,\n                              inputParam.created_by,\n                              new Date(),\n                              inputParam.visit_code,\n                              inputParam.visit_expiery_date,\n                              inputParam.episode_id\n                            ],\n                            (error, visitresult) => {\n                              if (error) {\n                                dataBase.rollback(() => {\n                                  dataBase.release();\n                                  logger.log(\n                                    \"error\",\n                                    \"Add new visit %j\",\n                                    error\n                                  );\n                                });\n                              }\n                              req.visit_id = visitresult.insertId;\n                              let patient_visit_id = visitresult.insertId;\n\n                              debugLog(\n                                \"patient_visit_id : \" + patient_visit_id\n                              );\n\n                              if (patient_visit_id != null) {\n                                dataBase.query(\n                                  \"INSERT INTO `hims_f_patient_visit_message` (`patient_visit_id`\\\n, `patient_message`, `is_critical_message`, `message_active_till`, `created_by`, `created_date`\\\n) VALUES ( ?, ?, ?, ?, ?, ?);\",\n                                  [\n                                    patient_visit_id,\n                                    inputParam.patient_message,\n                                    inputParam.is_critical_message,\n                                    inputParam.message_active_till,\n                                    inputParam.created_by,\n                                    new Date()\n                                  ],\n                                  (error, resultData) => {\n                                    if (typeof callBack == \"function\") {\n                                      callBack(error, visitresult);\n                                    }\n                                  }\n                                );\n                              }\n                            }\n                          );\n                        }\n                      );\n                    }\n                  }\n                );\n              }\n            );\n          } else if (existingExparyDate > today) {\n            inputParam.visit_expiery_date = existingExparyDate;\n            inputParam.episode_id = currentPatientEpisodeNo;\n\n            // inserting patient visit\n            dataBase.query(\n              \"INSERT INTO `hims_f_patient_visit` (`patient_id`, `visit_type`, \\\n            `age_in_years`, `age_in_months`, `age_in_days`, `insured`,`sec_insured`,\\\n          `visit_date`, `department_id`, `sub_department_id`, `doctor_id`, `maternity_patient`,\\\n           `is_mlc`, `mlc_accident_reg_no`, `mlc_police_station`, `mlc_wound_certified_date`, \\\n           `created_by`, `created_date`,`visit_code`,`visit_expiery_date`,`episode_id`)\\\n          VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?);\",\n              [\n                inputParam.patient_id,\n                inputParam.visit_type,\n                inputParam.age_in_years,\n                inputParam.age_in_months,\n                inputParam.age_in_days,\n                inputParam.insured,\n                inputParam.sec_insured,\n                inputParam.visit_date,\n                inputParam.department_id,\n                inputParam.sub_department_id,\n                inputParam.doctor_id,\n                inputParam.maternity_patient,\n                inputParam.is_mlc,\n                inputParam.mlc_accident_reg_no,\n                inputParam.mlc_police_station,\n                inputParam.mlc_wound_certified_date,\n                inputParam.created_by,\n                new Date(),\n                inputParam.visit_code,\n                inputParam.visit_expiery_date,\n                inputParam.episode_id\n              ],\n              (error, visitresult) => {\n                if (error) {\n                  dataBase.rollback(() => {\n                    dataBase.release();\n                    logger.log(\"error\", \"Add new visit %j\", error);\n                  });\n                }\n                req.visit_id = visitresult.insertId;\n                let patient_visit_id = visitresult.insertId;\n\n                debugLog(\"patient_visit_id : \" + patient_visit_id);\n\n                if (patient_visit_id != null) {\n                  dataBase.query(\n                    \"INSERT INTO `hims_f_patient_visit_message` (`patient_visit_id`\\\n        , `patient_message`, `is_critical_message`, `message_active_till`, `created_by`, `created_date`\\\n        ) VALUES ( ?, ?, ?, ?, ?, ?);\",\n                    [\n                      patient_visit_id,\n                      inputParam.patient_message,\n                      inputParam.is_critical_message,\n                      inputParam.message_active_till,\n                      inputParam.created_by,\n                      new Date()\n                    ],\n                    (error, resultData) => {\n                      if (typeof callBack == \"function\") {\n                        callBack(error, visitresult);\n                      }\n                    }\n                  );\n                }\n              }\n            );\n          }\n        }\n      );\n    } //not for consultaion\n    else if (inputParam.consultation == \"N\") {\n      debugFunction(\"not for consultaion\");\n      dataBase.query(\n        \"INSERT INTO `hims_f_patient_visit` (`patient_id`, `visit_type`, \\\n      `age_in_years`, `age_in_months`, `age_in_days`, `insured`,`sec_insured`,\\\n    `visit_date`, `department_id`, `sub_department_id`, `doctor_id`, `maternity_patient`,\\\n     `is_mlc`, `mlc_accident_reg_no`, `mlc_police_station`, `mlc_wound_certified_date`, \\\n     `created_by`, `created_date`,`visit_code`,`visit_expiery_date`)\\\n    VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?);\",\n        [\n          inputParam.patient_id,\n          inputParam.visit_type,\n          inputParam.age_in_years,\n          inputParam.age_in_months,\n          inputParam.age_in_days,\n          inputParam.insured,\n          inputParam.sec_insured,\n          inputParam.visit_date,\n          inputParam.department_id,\n          inputParam.sub_department_id,\n          inputParam.doctor_id,\n          inputParam.maternity_patient,\n          inputParam.is_mlc,\n          inputParam.mlc_accident_reg_no,\n          inputParam.mlc_police_station,\n          inputParam.mlc_wound_certified_date,\n          inputParam.created_by,\n          new Date(),\n          inputParam.visit_code,\n          today\n        ],\n        (error, result) => {\n          if (error) {\n            dataBase.rollback(() => {\n              dataBase.release();\n              logger.log(\"error\", \"Add new visit %j\", error);\n            });\n          }\n          req.visit_id = result.insertId;\n          let patient_visit_id = result.insertId;\n\n          debugLog(\"patient_visit_id : \" + patient_visit_id);\n\n          if (patient_visit_id != null) {\n            dataBase.query(\n              \"INSERT INTO `hims_f_patient_visit_message` (`patient_visit_id`\\\n  , `patient_message`, `is_critical_message`, `message_active_till`, `created_by`, `created_date`\\\n  ) VALUES ( ?, ?, ?, ?, ?, ?);\",\n              [\n                patient_visit_id,\n                inputParam.patient_message,\n                inputParam.is_critical_message,\n                inputParam.message_active_till,\n                inputParam.created_by,\n                new Date()\n              ],\n              (error, resultData) => {\n                if (typeof callBack == \"function\") {\n                  callBack(error, result);\n                }\n              }\n            );\n          }\n        }\n      );\n    }\n  } catch (e) {\n    next(e);\n  }\n};\n\nlet updateVisit = (req, res, next) => {\n  try {\n    if (req.db == null) {\n      next(httpStatus.dataBaseNotInitilizedError());\n    }\n    let db = req.db;\n    db.getConnection((error, connection) => {\n      if (error) {\n        next(error);\n      }\n      updateData(connection, req, (error, result) => {\n        connection.release();\n        if (error) {\n          next(error);\n        }\n        req.records = result;\n        next();\n      });\n    });\n  } catch (e) {\n    next(e);\n  }\n};\n\nlet updateData = (dataBase, req, callBack) => {\n  let visitDetails = {\n    hims_f_patient_visit_id: null,\n    patient_id: null,\n    visit_type: null,\n    visit_date: null,\n    visit_code: null,\n    department_id: null,\n    sub_department_id: null,\n    doctor_id: null,\n    maternity_patient: null,\n    is_mlc: null,\n    mlc_accident_reg_no: null,\n    mlc_police_station: null,\n    mlc_wound_certified_date: null,\n    created_by: null,\n    created_date: null,\n    updated_by: null,\n    updated_date: null,\n    record_status: null,\n    patient_message: null,\n    is_critical_message: null,\n    message_active_till: null,\n    visit_expiery_date: null\n  };\n\n  try {\n    let inputParam = extend(visitDetails, req.body);\n    dataBase.query(\n      \"UPDATE `hims_f_patient_visit`\\\n    SET `visit_type`=?, `visit_date`=?, `department_id`=?, `sub_department_id`=?\\\n    ,`doctor_id`=?, `maternity_patient`=?, `is_mlc`=?, `mlc_accident_reg_no`=?,\\\n    `mlc_police_station`=?, `mlc_wound_certified_date`=?, `updated_by`=?, `updated_date`=?\\\n    WHERE `hims_f_patient_visit_id`=?;\",\n      [\n        inputParam.visit_type,\n        inputParam.visit_date,\n        inputParam.department_id,\n        inputParam.sub_department_id,\n        inputParam.doctor_id,\n        inputParam.maternity_patient,\n        inputParam.is_mlc,\n        inputParam.mlc_accident_reg_no,\n        inputParam.mlc_police_station,\n        inputParam.mlc_wound_certified_date,\n        inputParam.updated_by,\n        new Date(),\n        inputParam.hims_f_patient_visit_id\n      ],\n      (error, result) => {\n        if (typeof callBack == \"function\") {\n          callBack(error, result);\n        }\n      }\n    );\n  } catch (e) {\n    next(e);\n  }\n};\n\nlet checkVisitExists = (req, res, next) => {\n  try {\n    if (req.db == null) {\n      next(httpStatus.dataBaseNotInitilizedError());\n    }\n    let db = req.db;\n    let inputParam = extend(\n      {\n        sub_department_id: null,\n        doctor_id: null,\n        patient_id: null\n      },\n      req.body\n    );\n    db.getConnection((error, connection) => {\n      if (error) {\n        next(error);\n      }\n      db.query(\n        \"select visit_code from hims_d_sub_department,hims_f_patient_visit where \\\n      hims_f_patient_visit.sub_department_id=hims_d_sub_department.hims_d_sub_department_id \\\n      and hims_d_sub_department.record_status='A' and hims_f_patient_visit.record_status='A' \\\n      and hims_f_patient_visit.visit_date =DATE(now()) and hims_d_sub_department.hims_d_sub_department_id=?\\\n      and hims_f_patient_visit.doctor_id=? and patient_id =? \\\n      \",\n        [\n          inputParam.sub_department_id,\n          inputParam.doctor_id,\n          inputParam.patient_id\n        ],\n        (error, records) => {\n          connection.release();\n          if (error) {\n            next(error);\n          }\n          req.records = records;\n          next();\n        }\n      );\n    });\n  } catch (e) {\n    next(e);\n  }\n};\n\nmodule.exports = {\n  addVisit,\n  updateVisit,\n  insertVisitData,\n  checkVisitExists,\n  insertPatientVisitData\n};\n"]}