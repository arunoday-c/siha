{"version":3,"sources":["../../src/model/visit.js"],"names":["insertPatientVisitData","req","res","next","header","headers","JSON","parse","inputParam","hims_f_patient_visit_id","patient_id","visit_type","visit_date","Date","visit_code","age_in_years","age_in_months","age_in_days","insured","sec_insured","department_id","sub_department_id","doctor_id","maternity_patient","is_mlc","mlc_accident_reg_no","mlc_police_station","mlc_wound_certified_date","created_by","user_id","created_date","updated_by","updated_date","record_status","patient_message","is_critical_message","message_active_till","visit_expiery_date","episode_id","consultation","query","body","db","options","existingExparyDate","currentPatientEpisodeNo","internalInsertPatientVisitData","fromDate","date_of_birth","toDate","years","diff","add","months","days","undefined","error","visitresult","rollback","onFailure","visit_id","insertId","patient_visit_id","resultData","eror","onSuccess","expResult","length","format","currentEpisodeNo","today","record","generateError","notModified","parseInt","nextEpisodeNo","updateResult","dataBase","noContent","e","addVisit","dataBaseNotInitilizedError","getConnection","connection","beginTransaction","insertVisitData","result","commit","records","numUpdate","completeNumber","callBack","visitDetails","release","log","updateVisit","updateData","checkVisitExists","module","exports"],"mappings":"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","file":"visit.js","sourcesContent":["import extend from \"extend\";\nimport httpStatus from \"../utils/httpStatus\";\nimport { debugLog, debugFunction, logger } from \"../utils/logging\";\nimport { whereCondition, runningNumber, releaseDBConnection } from \"../utils\";\nimport moment from \"moment\";\n\n//Added by noor for code optimization\nlet insertPatientVisitData = (req, res, next) => {\n  try {\n    debugFunction(\"insertPatientVisitData\");\n    let header = req.headers[\"x-app-user-identity\"];\n    header = JSON.parse(header);\n    let inputParam = extend(\n      {\n        hims_f_patient_visit_id: null,\n        patient_id: null,\n        visit_type: null,\n        visit_date: new Date(),\n        visit_code: null,\n        age_in_years: null,\n        age_in_months: null,\n        age_in_days: null,\n        insured: null,\n        sec_insured: null,\n        department_id: null,\n        sub_department_id: null,\n        doctor_id: null,\n        maternity_patient: null,\n        is_mlc: null,\n        mlc_accident_reg_no: null,\n        mlc_police_station: null,\n        mlc_wound_certified_date: null,\n        created_by: header.user_id,\n        created_date: null,\n        updated_by: header.user_id,\n        updated_date: null,\n        record_status: null,\n        patient_message: null,\n        is_critical_message: null,\n        message_active_till: null,\n        visit_expiery_date: null,\n        episode_id: null,\n        consultation: null\n      },\n      req.query[\"data\"] == null ? req.body : req.query\n    );\n\n    let db = req.options != null ? req.options.db : req.db;\n    let existingExparyDate = null;\n    let currentPatientEpisodeNo = null;\n\n    inputParam.patient_id = req.patient_id || req.body.patient_id;\n    debugLog(\"Body:\", req.body);\n    const internalInsertPatientVisitData = () => {\n      if (inputParam.age_in_years == null) {\n        let fromDate = moment(inputParam.date_of_birth);\n        let toDate = new Date();\n        let years = moment(toDate).diff(fromDate, \"year\");\n        fromDate.add(years, \"years\");\n        let months = moment(toDate).diff(fromDate, \"months\");\n        fromDate.add(months, \"months\");\n        let days = moment(toDate).diff(fromDate, \"days\");\n        inputParam.age_in_years = years;\n        inputParam.age_in_months = months;\n        inputParam.age_in_days = days;\n      }\n      if (existingExparyDate == null || existingExparyDate == undefined) {\n        inputParam.visit_expiery_date = existingExparyDate;\n        inputParam.episode_id = currentPatientEpisodeNo;\n      }\n      debugLog(\"inside internalInsertPatientVisitData\");\n      db.query(\n        \"INSERT INTO `hims_f_patient_visit` (`patient_id`, `visit_type`, \\\n`age_in_years`, `age_in_months`, `age_in_days`, `insured`,`sec_insured`,\\\n`visit_date`, `department_id`, `sub_department_id`, `doctor_id`, `maternity_patient`,\\\n`is_mlc`, `mlc_accident_reg_no`, `mlc_police_station`, `mlc_wound_certified_date`, \\\n`created_by`, `created_date`,`visit_code`,`visit_expiery_date`,`episode_id`)\\\nVALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?);\",\n        [\n          inputParam.patient_id,\n          inputParam.visit_type,\n          inputParam.age_in_years,\n          inputParam.age_in_months,\n          inputParam.age_in_days,\n          inputParam.insured,\n          inputParam.sec_insured,\n          inputParam.visit_date,\n          inputParam.department_id,\n          inputParam.sub_department_id,\n          inputParam.doctor_id,\n          inputParam.maternity_patient,\n          inputParam.is_mlc,\n          inputParam.mlc_accident_reg_no,\n          inputParam.mlc_police_station,\n          inputParam.mlc_wound_certified_date,\n          inputParam.created_by,\n          new Date(),\n          inputParam.visit_code,\n          inputParam.visit_expiery_date,\n          inputParam.episode_id\n        ],\n        (error, visitresult) => {\n          if (error) {\n            if (req.options == null) {\n              db.rollback(() => {\n                releaseDBConnection(req.db, db);\n              });\n            } else {\n              req.options.onFailure(error);\n            }\n          }\n          req.visit_id = visitresult.insertId;\n          let patient_visit_id = visitresult.insertId;\n\n          if (patient_visit_id != null) {\n            db.query(\n              \"INSERT INTO `hims_f_patient_visit_message` (`patient_visit_id`\\\n, `patient_message`, `is_critical_message`, `message_active_till`, `created_by`, `created_date`\\\n) VALUES ( ?, ?, ?, ?, ?, ?);\",\n              [\n                patient_visit_id,\n                inputParam.patient_message,\n                inputParam.is_critical_message,\n                inputParam.message_active_till,\n                inputParam.created_by,\n                new Date()\n              ],\n              (error, resultData) => {\n                if (error) {\n                  if (req.options == null) {\n                    db.rollback(() => {\n                      releaseDBConnection(req.db, db);\n                      next(error);\n                    });\n                  } else {\n                    req.options.onFailure(eror);\n                  }\n                } else {\n                  req.options.onSuccess(visitresult);\n                }\n              }\n            );\n          }\n        }\n      );\n    };\n    //for consultaion\n    if (inputParam.consultation == \"Y\") {\n      debugLog(\"In consultation == Y \");\n      db.query(\n        \" select max(visit_expiery_date) as visit_expiery_date,episode_id from hims_f_patient_visit where\\\n         patient_id=? and doctor_id=? and record_status='A' group by patient_id, doctor_id;\",\n        [inputParam.patient_id, inputParam.doctor_id],\n        (error, expResult) => {\n          debugLog(\"In consultation Query\", expResult);\n          if (error) {\n            if (req.options == null) {\n              db.rollback(() => {\n                releaseDBConnection(req.db, db);\n              });\n            } else {\n              req.options.onFailure(error);\n            }\n          } else {\n            //fetching expiry date and episode id for existing patient\n            if (expResult[0] != null || expResult.length != 0) {\n              existingExparyDate = moment(\n                expResult[0][\"visit_expiery_date\"]\n              ).format(\"YYYY-MM-DD\");\n              currentPatientEpisodeNo = expResult[0][\"episode_id\"];\n            }\n            let currentEpisodeNo = null;\n            //checking expiry if expired or not_there create new expiry date\n            if (\n              existingExparyDate == null ||\n              existingExparyDate == undefined ||\n              existingExparyDate < today\n            ) {\n              //create new expiry date\n              db.query(\n                \"SELECT param_value,episode_id from algaeh_d_app_config WHERE algaeh_d_app_config_id=11 \\\n    and record_status='A'\",\n                (error, record) => {\n                  debugLog(\"In Expiry date records \", record);\n                  if (error) {\n                    if (req.options == null) {\n                      db.rollback(() => {\n                        releaseDBConnection(req.db, db);\n                        next(error);\n                      });\n                    } else {\n                      req.options.onFailure(error);\n                    }\n                  } else {\n                    if (record.length == 0) {\n                      if (req.options == null) {\n                        db.rollback(() => {\n                          releaseDBConnection(req.db, db);\n                          next(\n                            httpStatus.generateError(\n                              httpStatus.notModified,\n                              \"Episode value not found.Please contact administrator.\"\n                            )\n                          );\n                        });\n                      } else {\n                        req.options.onFailure(\n                          httpStatus.generateError(\n                            httpStatus.notModified,\n                            \"Episode value not found.Please contact administrator.\"\n                          )\n                        );\n                      }\n                    }\n                    inputParam.visit_expiery_date = moment()\n                      .add(parseInt(record[0][\"param_value\"]), \"days\")\n                      .format(\"YYYY-MM-DD\");\n                    currentEpisodeNo = record[0].episode_id;\n\n                    if (currentEpisodeNo > 0) {\n                      let nextEpisodeNo = currentEpisodeNo + 1;\n                      inputParam.episode_id = currentEpisodeNo;\n                      db.query(\n                        \"update algaeh_d_app_config set episode_id=? where algaeh_d_app_config_id=11 and record_status='A' \",\n                        [nextEpisodeNo],\n                        (error, updateResult) => {\n                          if (error) {\n                            if (req.options == null) {\n                              db.rollback(() => {\n                                releaseDBConnection(req.db, dataBase);\n                                next(error);\n                              });\n                            } else {\n                              req.options.onFailure(error);\n                            }\n                          } else {\n                            internalInsertPatientVisitData();\n                          }\n                        }\n                      );\n                    }\n                  }\n                }\n              );\n            }\n          }\n        }\n      );\n    }\n    //for non consultaion\n    else if (inputParam.consultation == \"N\") {\n      inputParam.visit_expiery_date = new Date();\n      inputParam.episode_id = null;\n      internalInsertPatientVisitData();\n    } else {\n      if (req.options == null) {\n        db.rollback(() => {\n          releaseDBConnection(req.db, db);\n          next(\n            httpStatus.generateError(\n              httpStatus.noContent,\n              \"Please select consultation type\"\n            )\n          );\n        });\n      } else {\n        req.options.onFailure(\n          httpStatus.generateError(\n            httpStatus.noContent,\n            \"Please select consultation type\"\n          )\n        );\n      }\n    }\n  } catch (e) {\n    next(e);\n  }\n};\n\n//----end\n\nlet addVisit = (req, res, next) => {\n  try {\n    debugFunction(\"addVisit\");\n    if (req.db == null) {\n      next(httpStatus.dataBaseNotInitilizedError());\n    }\n    let db = req.db;\n    db.getConnection((error, connection) => {\n      if (error) {\n        next(error);\n      }\n      connection.beginTransaction(error => {\n        if (error) {\n          connection.rollback(() => {\n            next(error);\n          });\n        }\n\n        let patient_id =\n          req.body.patient_id != null\n            ? req.body.patient_id\n            : req.query.patient_id;\n        let visit_code =\n          req.body.visit_code != null\n            ? req.body.visit_code\n            : req.query.visit_code;\n        if (visit_code != \"\" && patient_id != null) {\n          insertVisitData(connection, req, res, (error, result) => {\n            if (error) {\n              connection.rollback(() => {\n                next(error);\n              });\n            }\n            connection.commit(error => {\n              if (error) {\n                connection.rollback(() => {\n                  next(error);\n                });\n              }\n              req.records = result;\n              next();\n            });\n          });\n        } else {\n          if (patient_id == null) {\n            next(\n              httpStatus.generateError(400, \"Patient Code is not generated\")\n            );\n          } else {\n            runningNumber(\n              connection,\n              2,\n              \"VISIT_NUMGEN\",\n              (error, numUpdate, completeNumber) => {\n                if (error) {\n                  connection.rollback(() => {\n                    releaseDBConnection(db, connection);\n                    next(error);\n                  });\n                }\n                req.query.visit_code = completeNumber;\n                req.body.visit_code = completeNumber;\n                debugLog(\"req.body.visit_code : \" + completeNumber);\n                insertVisitData(connection, req, res, (error, result) => {\n                  if (error) {\n                    connection.rollback(() => {\n                      next(error);\n                    });\n                  }\n                  connection.commit(error => {\n                    if (error) {\n                      connection.rollback(() => {\n                        next(error);\n                      });\n                    }\n                    req.records = result;\n                    next();\n                  });\n                });\n              }\n            );\n          }\n        }\n      });\n    });\n  } catch (e) {\n    next(e);\n  }\n};\n\nlet insertVisitData = (dataBase, req, res, callBack) => {\n  let visitDetails = {\n    hims_f_patient_visit_id: null,\n    patient_id: null,\n    visit_type: null,\n    visit_date: new Date(),\n    visit_code: null,\n    age_in_years: null,\n    age_in_months: null,\n    age_in_days: null,\n    insured: null,\n    sec_insured: null,\n    department_id: null,\n    sub_department_id: null,\n    doctor_id: null,\n    maternity_patient: null,\n    is_mlc: null,\n    mlc_accident_reg_no: null,\n    mlc_police_station: null,\n    mlc_wound_certified_date: null,\n    created_by: null,\n    created_date: null,\n    updated_by: null,\n    updated_date: null,\n    record_status: null,\n    patient_message: null,\n    is_critical_message: null,\n    message_active_till: null,\n    visit_expiery_date: null,\n    episode_id: null,\n    consultation: null\n  };\n  try {\n    debugFunction(\"insertVisitData\");\n    let inputParam = extend(\n      visitDetails,\n      req.query[\"data\"] == null ? req.body : req.query\n    );\n\n    let today = moment().format(\"YYYY-MM-DD\");\n\n    //for consultaion\n    if (inputParam.consultation == \"Y\") {\n      dataBase.query(\n        \" select max(visit_expiery_date) as visit_expiery_date,episode_id from hims_f_patient_visit where\\\n         patient_id=? and doctor_id=? and record_status='A' group by patient_id, doctor_id;\",\n        [inputParam.patient_id, inputParam.doctor_id],\n        (error, expResult) => {\n          if (error) {\n            dataBase.rollback(() => {\n              dataBase.release();\n              debugLog(\"error \", error);\n            });\n          }\n\n          let existingExparyDate = null;\n          let currentPatientEpisodeNo = null;\n\n          //fetching expiry date and episode id for existing patient\n          if (expResult[0] != null || expResult.length != 0) {\n            existingExparyDate = moment(\n              expResult[0][\"visit_expiery_date\"]\n            ).format(\"YYYY-MM-DD\");\n\n            debugLog(\"existingExparyDate:\", existingExparyDate);\n\n            currentPatientEpisodeNo = expResult[0][\"episode_id\"];\n            debugLog(\"currentPatientEpisodeNo:\", currentPatientEpisodeNo);\n          }\n\n          let currentEpisodeNo = null;\n\n          //checking expiry if expired or not_there create new expiry date\n          if (\n            existingExparyDate == null ||\n            existingExparyDate == undefined ||\n            existingExparyDate < today\n          ) {\n            //create new expiry date\n            dataBase.query(\n              \"SELECT param_value from algaeh_d_app_config WHERE param_name=?\",\n              [\"VISITEXPERIDAY\"],\n              (error, record) => {\n                if (error) {\n                  dataBase.rollback(() => {\n                    dataBase.release();\n                    logger.log(\"error\", \"Add new visit %j\", error);\n                  });\n                }\n\n                inputParam.visit_expiery_date = moment()\n                  .add(\n                    record != null && record.length != 0\n                      ? parseInt(record[0][\"param_value\"])\n                      : 0,\n                    \"days\"\n                  )\n                  .format(\"YYYY-MM-DD\");\n                debugLog(\n                  \"new expiry date created:\",\n                  inputParam.visit_expiery_date\n                );\n\n                // create new episode\n                dataBase.query(\n                  \"select episode_id from algaeh_d_app_config where algaeh_d_app_config_id=11 and record_status='A'\",\n                  (error, result) => {\n                    if (error) {\n                      releaseDBConnection(req.db, dataBase);\n                      next(error);\n                    }\n\n                    currentEpisodeNo = result[0].episode_id;\n                    debugLog(\"currentEpisodeNo:\", currentEpisodeNo);\n\n                    //increament episode id\n                    if (currentEpisodeNo > 0) {\n                      let nextEpisodeNo = currentEpisodeNo + 1;\n                      debugLog(\"nextEpisodeNo :\", nextEpisodeNo);\n                      inputParam.episode_id = currentEpisodeNo;\n\n                      dataBase.query(\n                        \"update algaeh_d_app_config set episode_id=? where algaeh_d_app_config_id=11 and record_status='A' \",\n                        [nextEpisodeNo],\n                        (error, updateResult) => {\n                          if (error) {\n                            dataBase.rollback(() => {\n                              releaseDBConnection(req.db, dataBase);\n                              next(error);\n                            });\n                          }\n\n                          // inserting patient visit\n                          dataBase.query(\n                            \"INSERT INTO `hims_f_patient_visit` (`patient_id`, `visit_type`, \\\n    `age_in_years`, `age_in_months`, `age_in_days`, `insured`,`sec_insured`,\\\n  `visit_date`, `department_id`, `sub_department_id`, `doctor_id`, `maternity_patient`,\\\n   `is_mlc`, `mlc_accident_reg_no`, `mlc_police_station`, `mlc_wound_certified_date`, \\\n   `created_by`, `created_date`,`visit_code`,`visit_expiery_date`,`episode_id`)\\\n  VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?);\",\n                            [\n                              inputParam.patient_id,\n                              inputParam.visit_type,\n                              inputParam.age_in_years,\n                              inputParam.age_in_months,\n                              inputParam.age_in_days,\n                              inputParam.insured,\n                              inputParam.sec_insured,\n                              inputParam.visit_date,\n                              inputParam.department_id,\n                              inputParam.sub_department_id,\n                              inputParam.doctor_id,\n                              inputParam.maternity_patient,\n                              inputParam.is_mlc,\n                              inputParam.mlc_accident_reg_no,\n                              inputParam.mlc_police_station,\n                              inputParam.mlc_wound_certified_date,\n                              inputParam.created_by,\n                              new Date(),\n                              inputParam.visit_code,\n                              inputParam.visit_expiery_date,\n                              inputParam.episode_id\n                            ],\n                            (error, visitresult) => {\n                              if (error) {\n                                dataBase.rollback(() => {\n                                  dataBase.release();\n                                  logger.log(\n                                    \"error\",\n                                    \"Add new visit %j\",\n                                    error\n                                  );\n                                });\n                              }\n                              req.visit_id = visitresult.insertId;\n                              let patient_visit_id = visitresult.insertId;\n\n                              debugLog(\n                                \"patient_visit_id : \" + patient_visit_id\n                              );\n\n                              if (patient_visit_id != null) {\n                                dataBase.query(\n                                  \"INSERT INTO `hims_f_patient_visit_message` (`patient_visit_id`\\\n, `patient_message`, `is_critical_message`, `message_active_till`, `created_by`, `created_date`\\\n) VALUES ( ?, ?, ?, ?, ?, ?);\",\n                                  [\n                                    patient_visit_id,\n                                    inputParam.patient_message,\n                                    inputParam.is_critical_message,\n                                    inputParam.message_active_till,\n                                    inputParam.created_by,\n                                    new Date()\n                                  ],\n                                  (error, resultData) => {\n                                    if (typeof callBack == \"function\") {\n                                      callBack(error, visitresult);\n                                    }\n                                  }\n                                );\n                              }\n                            }\n                          );\n                        }\n                      );\n                    }\n                  }\n                );\n              }\n            );\n          } else if (existingExparyDate > today) {\n            inputParam.visit_expiery_date = existingExparyDate;\n            inputParam.episode_id = currentPatientEpisodeNo;\n\n            // inserting patient visit\n            dataBase.query(\n              \"INSERT INTO `hims_f_patient_visit` (`patient_id`, `visit_type`, \\\n            `age_in_years`, `age_in_months`, `age_in_days`, `insured`,`sec_insured`,\\\n          `visit_date`, `department_id`, `sub_department_id`, `doctor_id`, `maternity_patient`,\\\n           `is_mlc`, `mlc_accident_reg_no`, `mlc_police_station`, `mlc_wound_certified_date`, \\\n           `created_by`, `created_date`,`visit_code`,`visit_expiery_date`,`episode_id`)\\\n          VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?);\",\n              [\n                inputParam.patient_id,\n                inputParam.visit_type,\n                inputParam.age_in_years,\n                inputParam.age_in_months,\n                inputParam.age_in_days,\n                inputParam.insured,\n                inputParam.sec_insured,\n                inputParam.visit_date,\n                inputParam.department_id,\n                inputParam.sub_department_id,\n                inputParam.doctor_id,\n                inputParam.maternity_patient,\n                inputParam.is_mlc,\n                inputParam.mlc_accident_reg_no,\n                inputParam.mlc_police_station,\n                inputParam.mlc_wound_certified_date,\n                inputParam.created_by,\n                new Date(),\n                inputParam.visit_code,\n                inputParam.visit_expiery_date,\n                inputParam.episode_id\n              ],\n              (error, visitresult) => {\n                if (error) {\n                  dataBase.rollback(() => {\n                    dataBase.release();\n                    logger.log(\"error\", \"Add new visit %j\", error);\n                  });\n                }\n                req.visit_id = visitresult.insertId;\n                let patient_visit_id = visitresult.insertId;\n\n                debugLog(\"patient_visit_id : \" + patient_visit_id);\n\n                if (patient_visit_id != null) {\n                  dataBase.query(\n                    \"INSERT INTO `hims_f_patient_visit_message` (`patient_visit_id`\\\n        , `patient_message`, `is_critical_message`, `message_active_till`, `created_by`, `created_date`\\\n        ) VALUES ( ?, ?, ?, ?, ?, ?);\",\n                    [\n                      patient_visit_id,\n                      inputParam.patient_message,\n                      inputParam.is_critical_message,\n                      inputParam.message_active_till,\n                      inputParam.created_by,\n                      new Date()\n                    ],\n                    (error, resultData) => {\n                      if (typeof callBack == \"function\") {\n                        callBack(error, visitresult);\n                      }\n                    }\n                  );\n                }\n              }\n            );\n          }\n        }\n      );\n    } //not for consultaion\n    else if (inputParam.consultation == \"N\") {\n      debugFunction(\"not for consultaion\");\n      dataBase.query(\n        \"INSERT INTO `hims_f_patient_visit` (`patient_id`, `visit_type`, \\\n      `age_in_years`, `age_in_months`, `age_in_days`, `insured`,`sec_insured`,\\\n    `visit_date`, `department_id`, `sub_department_id`, `doctor_id`, `maternity_patient`,\\\n     `is_mlc`, `mlc_accident_reg_no`, `mlc_police_station`, `mlc_wound_certified_date`, \\\n     `created_by`, `created_date`,`visit_code`,`visit_expiery_date`)\\\n    VALUES ( ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?);\",\n        [\n          inputParam.patient_id,\n          inputParam.visit_type,\n          inputParam.age_in_years,\n          inputParam.age_in_months,\n          inputParam.age_in_days,\n          inputParam.insured,\n          inputParam.sec_insured,\n          inputParam.visit_date,\n          inputParam.department_id,\n          inputParam.sub_department_id,\n          inputParam.doctor_id,\n          inputParam.maternity_patient,\n          inputParam.is_mlc,\n          inputParam.mlc_accident_reg_no,\n          inputParam.mlc_police_station,\n          inputParam.mlc_wound_certified_date,\n          inputParam.created_by,\n          new Date(),\n          inputParam.visit_code,\n          today\n        ],\n        (error, result) => {\n          if (error) {\n            dataBase.rollback(() => {\n              dataBase.release();\n              logger.log(\"error\", \"Add new visit %j\", error);\n            });\n          }\n          req.visit_id = result.insertId;\n          let patient_visit_id = result.insertId;\n\n          debugLog(\"patient_visit_id : \" + patient_visit_id);\n\n          if (patient_visit_id != null) {\n            dataBase.query(\n              \"INSERT INTO `hims_f_patient_visit_message` (`patient_visit_id`\\\n  , `patient_message`, `is_critical_message`, `message_active_till`, `created_by`, `created_date`\\\n  ) VALUES ( ?, ?, ?, ?, ?, ?);\",\n              [\n                patient_visit_id,\n                inputParam.patient_message,\n                inputParam.is_critical_message,\n                inputParam.message_active_till,\n                inputParam.created_by,\n                new Date()\n              ],\n              (error, resultData) => {\n                if (typeof callBack == \"function\") {\n                  callBack(error, result);\n                }\n              }\n            );\n          }\n        }\n      );\n    }\n  } catch (e) {\n    next(e);\n  }\n};\n\nlet updateVisit = (req, res, next) => {\n  try {\n    if (req.db == null) {\n      next(httpStatus.dataBaseNotInitilizedError());\n    }\n    let db = req.db;\n    db.getConnection((error, connection) => {\n      if (error) {\n        next(error);\n      }\n      updateData(connection, req, (error, result) => {\n        connection.release();\n        if (error) {\n          next(error);\n        }\n        req.records = result;\n        next();\n      });\n    });\n  } catch (e) {\n    next(e);\n  }\n};\n\nlet updateData = (dataBase, req, callBack) => {\n  let visitDetails = {\n    hims_f_patient_visit_id: null,\n    patient_id: null,\n    visit_type: null,\n    visit_date: null,\n    visit_code: null,\n    department_id: null,\n    sub_department_id: null,\n    doctor_id: null,\n    maternity_patient: null,\n    is_mlc: null,\n    mlc_accident_reg_no: null,\n    mlc_police_station: null,\n    mlc_wound_certified_date: null,\n    created_by: null,\n    created_date: null,\n    updated_by: null,\n    updated_date: null,\n    record_status: null,\n    patient_message: null,\n    is_critical_message: null,\n    message_active_till: null,\n    visit_expiery_date: null\n  };\n\n  try {\n    let inputParam = extend(visitDetails, req.body);\n    dataBase.query(\n      \"UPDATE `hims_f_patient_visit`\\\n    SET `visit_type`=?, `visit_date`=?, `department_id`=?, `sub_department_id`=?\\\n    ,`doctor_id`=?, `maternity_patient`=?, `is_mlc`=?, `mlc_accident_reg_no`=?,\\\n    `mlc_police_station`=?, `mlc_wound_certified_date`=?, `updated_by`=?, `updated_date`=?\\\n    WHERE `hims_f_patient_visit_id`=?;\",\n      [\n        inputParam.visit_type,\n        inputParam.visit_date,\n        inputParam.department_id,\n        inputParam.sub_department_id,\n        inputParam.doctor_id,\n        inputParam.maternity_patient,\n        inputParam.is_mlc,\n        inputParam.mlc_accident_reg_no,\n        inputParam.mlc_police_station,\n        inputParam.mlc_wound_certified_date,\n        inputParam.updated_by,\n        new Date(),\n        inputParam.hims_f_patient_visit_id\n      ],\n      (error, result) => {\n        if (typeof callBack == \"function\") {\n          callBack(error, result);\n        }\n      }\n    );\n  } catch (e) {\n    next(e);\n  }\n};\n\nlet checkVisitExists = (req, res, next) => {\n  try {\n    if (req.db == null) {\n      next(httpStatus.dataBaseNotInitilizedError());\n    }\n    let db = req.db;\n    let inputParam = extend(\n      {\n        sub_department_id: null,\n        doctor_id: null,\n        patient_id: null\n      },\n      req.body\n    );\n    db.getConnection((error, connection) => {\n      if (error) {\n        next(error);\n      }\n      db.query(\n        \"select visit_code from hims_d_sub_department,hims_f_patient_visit where \\\n      hims_f_patient_visit.sub_department_id=hims_d_sub_department.hims_d_sub_department_id \\\n      and hims_d_sub_department.record_status='A' and hims_f_patient_visit.record_status='A' \\\n      and hims_f_patient_visit.visit_date =DATE(now()) and hims_d_sub_department.hims_d_sub_department_id=?\\\n      and hims_f_patient_visit.doctor_id=? and patient_id =? \\\n      \",\n        [\n          inputParam.sub_department_id,\n          inputParam.doctor_id,\n          inputParam.patient_id\n        ],\n        (error, records) => {\n          connection.release();\n          if (error) {\n            next(error);\n          }\n          req.records = records;\n          next();\n        }\n      );\n    });\n  } catch (e) {\n    next(e);\n  }\n};\n\nmodule.exports = {\n  addVisit,\n  updateVisit,\n  insertVisitData,\n  checkVisitExists,\n  insertPatientVisitData\n};\n"]}