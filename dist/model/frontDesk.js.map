{"version":3,"sources":["../../src/model/frontDesk.js"],"names":["addFrontDesk","req","res","next","db","dataBaseNotInitilizedError","getConnection","error","connection","beginTransaction","rollback","records","newNumber","length","body","patient_code","result","patient_id","patResults","completeNum","visit_code","resultdata","commit","e","selectWhere","hims_d_patient_id","selectFrontDesk","where","query","condition","values","showresult","resultFields","patientRegistration","visitDetails","module","exports"],"mappings":"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","file":"frontDesk.js","sourcesContent":["import { insertData } from \"../model/patientRegistration\";\nimport { insertVisitData } from \"../model/visit\";\nimport { whereCondition, runningNumber, releaseDBConnection } from \"../utils\";\nimport extend from \"extend\";\nimport httpStatus from \"../utils/httpStatus\";\nimport { debugLog, debugFunction } from \"../utils/logging\";\nlet addFrontDesk = (req, res, next) => {\n  debugFunction(\"addFrontDesk\");\n  try {\n    if (req.db == null) {\n      next(httpStatus.dataBaseNotInitilizedError());\n    }\n    let db = req.db;\n    db.getConnection((error, connection) => {\n      if (error) {\n        next(error);\n      }\n      connection.beginTransaction(error => {\n        if (error) {\n          connection.rollback(() => {\n            releaseDBConnection(db, connection);\n            next(error);\n          });\n        }\n        runningNumber(\n          connection,\n          1,\n          \"PATCODE_NUMGEN\",\n          (error, records, newNumber) => {\n            debugLog(\"newNumber:\" + newNumber);\n            if (error) {\n              connection.rollback(() => {\n                releaseDBConnection(db, connection);\n                next(error);\n              });\n            }\n            if (records.length != 0) {\n              connection.beginTransaction(error => {\n                if (error) {\n                  connection.rollback(() => {\n                    releaseDBConnection(db, connection);\n                    next(error);\n                  });\n                }\n                req.body.patient_code = newNumber;\n                insertData(\n                  connection,\n                  req,\n                  res,\n                  (error, result) => {\n                    if (error) {\n                      connection.rollback(() => {\n                        releaseDBConnection(db, connection);\n                        next(error);\n                      });\n                    }\n                    if (result != null && result.length != 0) {\n                      req.body.patient_id = result[0][\"hims_d_patient_id\"];\n                      debugLog(\n                        \"req.body.patient_id:\" + result[0][\"hims_d_patient_id\"]\n                      );\n                      runningNumber(\n                        connection,\n                        2,\n                        \"VISIT_NUMGEN\",\n                        (error, patResults, completeNum) => {\n                          if (error) {\n                            connection.rollback(() => {\n                              releaseDBConnection(db, connection);\n                              next(error);\n                            });\n                          }\n                          req.body.visit_code = completeNum;\n                          debugLog(\"req.body.visit_code : \" + completeNum);\n                          insertVisitData(\n                            connection,\n                            req,\n                            res,\n                            (error, resultdata) => {\n                              if (error) {\n                                connection.rollback(() => {\n                                  releaseDBConnection(db, connection);\n                                  next(error);\n                                });\n                              }\n                              connection.commit(error => {\n                                releaseDBConnection(db, connection);\n                                if (error) {\n                                  connection.rollback(() => {\n                                    next(error);\n                                  });\n                                }\n                                debugLog(\n                                  \"patient_code : \" + req.body.patient_code\n                                );\n                                resultdata[\"patient_code\"] =\n                                  req.body.patient_code;\n                                resultdata[\"visit_code\"] = req.body.visit_code;\n                                req.records = resultdata;\n                                next();\n                                return;\n                              });\n                            }\n                          );\n                        }\n                      );\n                    } else {\n                      connection.commit(error => {\n                        releaseDBConnection(db, connection);\n                        if (error) {\n                          connection.rollback(() => {\n                            next(error);\n                          });\n                        }\n                        req.records = result;\n                        next();\n                      });\n                    }\n                  },\n                  true,\n                  next\n                );\n              });\n            }\n          }\n        );\n      });\n    });\n  } catch (e) {\n    next(e);\n  }\n};\nlet selectWhere = {\n  patient_code: \"ALL\",\n  hims_d_patient_id: \"ALL\"\n};\nlet selectFrontDesk = (req, res, next) => {\n  try {\n    if (req.db == null) {\n      next(httpStatus.dataBaseNotInitilizedError());\n    }\n    let db = req.db;\n    db.getConnection((error, connection) => {\n      if (error) {\n        next(error);\n      }\n      let where = whereCondition(extend(selectWhere, req.query));\n      connection.query(\n        \"SELECT `hims_d_patient_id`, `patient_code`\\\n      , `registration_date`, `title_id`,`first_name`, `middle_name`, `last_name`\\\n      , `gender`, `religion_id`,`date_of_birth`, `age`, `marital_status`, `address1`\\\n      , `address2`,`contact_number`, `secondary_contact_number`, `email`\\\n      , `emergency_contact_name`,`emergency_contact_number`, `relationship_with_patient`\\\n      , `visa_type_id`,`nationality_id`, `postal_code`, `primary_identity_id`\\\n      , `primary_id_no`,`secondary_identity_id`, `secondary_id_no`, `photo_file`\\\n      , `primary_id_file`,`secondary_id_file` FROM `hims_f_patient` \\\n       WHERE `record_status`='A' AND \" +\n          where.condition,\n        where.values,\n        (error, result) => {\n          if (error) {\n            releaseDBConnection(db, connection);\n            next(error);\n          }\n          let showresult;\n          if (result.length != 0) {\n            let hims_d_patient_id = result[0][\"hims_d_patient_id\"];\n            connection.query(\n              \"SELECT `hims_f_patient_visit_id`, `patient_id`\\\n            , `visit_type`, `visit_date`, `department_id`, `sub_department_id`\\\n            , `doctor_id`, `maternity_patient`, `is_mlc`, `mlc_accident_reg_no`\\\n            , `mlc_police_station`, `mlc_wound_certified_date`\\\n             FROM `hims_f_patient_visit` WHERE `record_status`='A' AND \\\n             patient_id=? ORDER BY hims_f_patient_visit_id desc \",\n              [hims_d_patient_id],\n              (error, resultFields) => {\n                if (error) {\n                  releaseDBConnection(db, connection);\n                  next(error);\n                }\n                showresult = {\n                  patientRegistration: result[0],\n                  visitDetails: resultFields\n                };\n                req.records = showresult;\n                next();\n              }\n            );\n          } else {\n            req.records = showresult;\n            next();\n          }\n        }\n      );\n    });\n  } catch (e) {\n    next(e);\n  }\n};\nmodule.exports = {\n  addFrontDesk,\n  selectFrontDesk\n};\n"]}